@using CodeHub.Services
@inject NavigationManager NavigationManager
@inject UserService UserService
@inject ProblemService ProblemService
@inject ProgrammingLanguageService ProgrammingLanguageService
@inject TagService TagService
@inject ProblemHintService ProblemHintService

<AuthorizeView Roles="Admin,Učiteľ,Študent" Context="authContext">
    <Authorized>
        <EditForm Model="@_problem" OnValidSubmit="HandleCreateProblemFormSubmitAsync" FormName="CreateProblem">
            <DataAnnotationsValidator />
            <div class="container text-center fw-bold mt-3">
                @if (_showAlert)
                {
                    <div class="alert @_alertColor" role="alert">
                        @_alertMessage
                    </div>
                }
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Názov úlohy
                    </div>
                    <div class="mb-3 col-12 col-md-6">
                        <InputText id="title" type="text" @bind-Value="_problem.Title" class="form-control create-problem text-white" placeholder="Súčet dvoch čísel"/>
                        <ValidationMessage For="@(() => _problem.Title)"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Výber programovacieho jazyka
                    </div>
                    <div class="col mb-3">
                        <InputSelect @bind-Value="_problem.LanguageID" class="form-select bg-dark" aria-label="Default select example">
                            <option value="0" selected disabled hidden>-- Vyber programovací jazyk --</option>
                            @foreach (var language in _languages)
                            {
                                <option value="@language.Id">@language.Name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => _problem.LanguageID)"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Výber obťažnosti
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <InputSelect @bind-Value="_problem.Difficulty" class="form-select bg-dark" aria-label="Default select example">
                            <option selected disabled hidden value="0">-- Vyber obťažnosť --</option>
                            <option value="1" class="text-success">Ľahká</option>
                            <option value="2" class="text-warning">Stredná</option>
                            <option value="3" class="text-danger">Ťažká</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => _problem.Difficulty)"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Popis úlohy
                    </div>
                    <div class="mb-3 col-12 col-md-6">
                        <InputTextArea @bind-Value="_problem.Description" class="form-control bg-dark" id="TaskDescription" rows="9" placeholder="Napíšte funkciu, ktorá berie ako vstup dve celé čísla a vracia ich súčet."></InputTextArea>
                        <ValidationMessage For="@(() => _problem.Description)"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Výber značiek
                    </div>
                    <div class="mb-3 col-12 col-md-6">
                        <InputSelect @bind-Value="_selectedTag" class="form-select bg-dark">
                            <option selected disabled hidden value="">-- Vyber značky --</option>
                            @foreach (var tag in _tags.GroupBy(t => t.Name).Select(group => group.First()))
                            {
                                <option value="@tag.Name">@tag.Name</option>
                            }
                        </InputSelect>
                    </div>
                </div>
                <div class="row">
                    <div class="mt-3 text-end">
                        @if (_selectedTags.Any())
                        {
                            @foreach (var tag in _selectedTags)
                            {
                                <span class="badge" style="background-color: #C9E1F4; color: black; margin-right: 5px; font-size:15px">
                                    @tag
                                    <button type="button" class="btn btn-sm bg-danger" @onclick="() => RemoveTag(tag)" aria-label="Remove">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </span>
                            }
                        }
                    </div>
                </div>
                <div class="row mb-5">
                    <div class="mt-3 text-end pb-4 d-flex justify-content-end">
                        <button class="btn btn-primary me-2" type="button" @onclick="AddTag" disabled="@string.IsNullOrEmpty(_selectedTag)">
                            Pridaj značku
                        </button>
                        <button class="btn btn-danger" type="button" @onclick="RemoveTag" disabled="@(!_selectedTags.Any())">
                            Odstráň značku
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Príklady
                    </div>
                    <div class="col-12 col-md-6 d-flex flex-wrap justify-content-end gap-2">
                        @if (_examples.Any())
                        {
                            int i = 1;
                            @foreach (var example in _examples)
                            {
                                <span class="badge" style="background-color: #C9E1F4; color: black; margin-right: 5px; font-size:15px">
                                    Príklad @i
                                    <button type="button" class="btn btn-sm ms-1 bg-warning" @onclick="() => ShowModal(example)">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm bg-danger" @onclick="() => RemoveExample(example)" aria-label="Remove">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </span>
                                i++;
                            }
                        }
                    </div>
                </div>
                <div class="row">
                    <div class="mt-3 text-end pb-4 d-flex justify-content-end">
                        <button class="btn btn-primary me-2" type="button" @onclick="ShowModalExample">
                            Vytvor príklad
                        </button>
                        <button class="btn btn-danger" type="button" @onclick="RemoveExample" disabled="@(!_examples.Any())">
                            Odstráň príklad
                        </button>
                    </div>
                </div>
                @if (_showModalExample)
                {
                    <div class="modal d-block" style="background-color: rgba(0,0,0.1,0.7);" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content background-custom text-start">
                                <div class="modal-header text-white">
                                    <h5 class="modal-title">Upraviť príklad</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal" aria-label="Zatvoriť"></button>
                                </div>
                                <div class="modal-body text-white">
                                    <div class="mb-3">
                                        <label for="Input" class="form-label">Vstup</label>
                                        <InputTextArea @bind-Value="_editingExample.Input" class="form-control bg-dark text-white" rows="3"></InputTextArea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="Output" class="form-label">Požadovaný výstup</label>
                                        <InputTextArea @bind-Value="_editingExample.Output" class="form-control bg-dark text-white" rows="3"></InputTextArea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="Explanation" class="form-label">Vysvetlenie</label>
                                        <InputTextArea @bind-Value="_editingExample.Explanation" class="form-control bg-dark text-white" rows="4"></InputTextArea>
                                    </div>
                                </div>
                                <div class="modal-footer text-white">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Zrušiť</button>
                                    <button type="button" class="btn btn-primary" @onclick="() => { if (_editingExample.Id == 0) CreateExample(); else UpdateExample(); }">
                                        Uložiť
                                    </button>

                                </div>
                            </div>
                        </div>
                    </div>
                }
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Obmedzenia
                    </div>
                    <div class="mb-3 col-12 col-md-6">
                        <InputTextArea @bind-Value="_constraint.Constraint" @oninput="UpdateConstraint" class="form-control bg-dark" id="ConstraintFormControlTextare" rows="3"
                                       placeholder="Celé čísla a a b môžu mať akúkoľvek hodnotu v rozsahu 32-bitových celých čísel so znamienkom"></InputTextArea>
                        <div class="row">
                            <div class="mt-3 text-end">
                                @if (_constraints.Any())
                                {
                                    int i = 1;
                                    @foreach (var constraint in _constraints)
                                    {
                                        <span class="badge mb-1 pb-2" style="background-color: #042549; color: white; margin-right: 5px; font-size:15px; display:inline-block">
                                            <div class="mb-2">
                                                Obmedzenie @i
                                            </div>
                                            <div class="mb-2">
                                                <InputTextArea @bind-Value="constraint.Constraint" class="form-control bg-dark" rows="4"></InputTextArea>
                                            </div>
                                            <button type="button" class="btn btn-sm ms-1 bg-warning" @onclick="() => ShowModal(constraint)">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm ms-1 bg-danger" @onclick="() => RemoveConstraint(constraint)" aria-label="Remove">
                                                <i class="fa-solid fa-xmark"></i>
                                            </button>
                                        </span>
                                        i++;
                                    }
                                }
                            </div>
                        </div>
                        @* <ValidationMessage For="@(() => _problem.Constraints)"/> *@
                    </div>
                </div>
                @if (_showModalConstraint)
                {
                    <div class="modal d-block" style="background-color: rgba(0,0,0.1,0.7);" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content background-custom">
                                <div class="modal-header text-white">
                                    <h5 class="modal-title">Upraviť obmedzenie</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal" aria-label="Zatvoriť"></button>
                                </div>
                                <div class="modal-body text-white">
                                    <div class="mb-3">
                                        <InputTextArea @bind-Value="_editingConstraint.Constraint" class="form-control bg-dark text-white" rows="8"></InputTextArea>
                                    </div>
                                </div>
                                <div class="modal-footer text-white">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Zrušiť</button>
                                    <button type="button" class="btn btn-primary" @onclick="UpdateConstraintText">Uložiť</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                <div class="row">
                    <div class="mt-3 text-end pb-4 d-flex justify-content-end">
                        <button class="btn btn-primary me-2" type="button" @onclick="AddConstraint" disabled="@string.IsNullOrWhiteSpace(_constraint.Constraint)">
                            Pridaj obmedzenie
                        </button>
                        <button class="btn btn-danger" type="button" @onclick="RemoveConstraint" disabled="@(!_constraints.Any())">
                            Odstráň obmedzenie
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Nápovedy
                    </div>
                    <div class="mb-3 col-12 col-md-6">
                        <InputTextArea @bind-Value="_hint.Hint" @oninput="UpdateHint" class="form-control bg-dark" id="HintFormControlTextarea" rows="3" 
                                       placeholder="Pred sčítaním overte, či sú a a b väčšie ako 0"></InputTextArea>
                        <div class="row">
                            <div class="mt-3 text-end">
                                @if (_hints.Any())
                                {
                                    int i = 1;
                                    @foreach (var hint in _hints)
                                    {
                                        <span class="badge mb-1 pb-2" style="background-color: #042549; color: white; margin-right: 5px; font-size:15px; display:inline-block">
                                            <div class="mb-2">
                                                Nápoveda @i
                                            </div>
                                            <div class="mb-2">
                                                <InputTextArea @bind-Value="hint.Hint" class="form-control bg-dark" rows="4"></InputTextArea>
                                            </div>
                                            <button type="button" class="btn btn-sm ms-1 bg-warning" @onclick="() => ShowModal(hint)">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm ms-1 bg-danger" @onclick="() => RemoveHint(hint)" aria-label="Remove">
                                                <i class="fa-solid fa-xmark"></i>
                                            </button>
                                        </span>
                                        i++;
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
                @if (_showModalHint)
                {
                    <div class="modal d-block" style="background-color: rgba(0,0,0.1,0.7);" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content background-custom">
                                <div class="modal-header text-white">
                                    <h5 class="modal-title">Upraviť nápovedu</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal" aria-label="Zatvoriť"></button>
                                </div>
                                <div class="modal-body text-white">
                                    <div class="mb-3">
                                        <InputTextArea @bind-Value="_editingHint.Hint" class="form-control bg-dark text-white" rows="8"></InputTextArea>
                                    </div>
                                </div>
                                <div class="modal-footer text-white">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Zrušiť</button>
                                    <button type="button" class="btn btn-primary" @onclick="UpdateHintText">Uložiť</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="row">
                    <div class="mt-3 text-end pb-4 d-flex justify-content-end">
                        <button class="btn btn-primary me-2" type="button" @onclick="AddHint" disabled="@string.IsNullOrWhiteSpace(_hint.Hint)">
                            Pridaj nápovedu
                        </button>
                        <button class="btn btn-danger" type="button" @onclick="RemoveHint" disabled="@(!_hints.Any())">
                            Odstráň nápovedu
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12 col-md-6 text-start my-2">
                        Prednastavený kód
                    </div>
                    <div class="mb-3 col-12 col-md-6">
                        <InputTextArea @bind-Value="_problem.DefaultCode" class="form-control bg-dark" id="DefaultCode" rows="10" 
                                       @oninput="OnCodeInput" placeholder="class HelloWorld {
    public static void main(String[] args) {
        int number = 10;
        System.out.println(number); 
    }
}"></InputTextArea>
                        <ValidationMessage For="@(() => _problem.DefaultCode)" />
                    </div>
                </div>

                <div class="row">
                    <div class="col my-3">
                        <button class="btn btn-success me-2" type="submit">Vytvoriť</button>
                        <button class="btn btn-danger" @onclick="CancelCreation">Zrušiť</button>
                    </div>
                </div>
            </div>
        </EditForm>
    </Authorized>
    <NotAuthorized>
        <div align="center" style="color: ghostwhite">
            <h3>Pre vytvorenie úlohy sa musíte najskôr prihlásiť. Ak nemáte účet, zaregistrujte sa.</h3>
        </div>
    </NotAuthorized>
</AuthorizeView>